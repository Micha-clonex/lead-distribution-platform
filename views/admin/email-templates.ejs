<style>
.template-card {
    border: 1px solid #e1e1e1;
    border-radius: 8px;
    transition: box-shadow 0.3s;
}
.template-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.btn-action {
    margin: 0 2px;
    padding: 5px 10px;
    font-size: 12px;
}
</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Email Template Management</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#templateModal">
            <i class="fas fa-plus me-2"></i>Add Template
        </button>
    </div>
</div>

<!-- Email Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Pending Emails</h6>
                        <h3 class="mb-0"><%= emailStats.pending %></h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Emails Sent</h6>
                        <h3 class="mb-0"><%= emailStats.sent %></h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Failed Emails</h6>
                        <h3 class="mb-0"><%= emailStats.failed %></h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-times fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Templates</h6>
                        <h3 class="mb-0"><%= templates.length %></h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-envelope-open fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Templates Table -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-envelope me-2"></i>Email Templates
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Subject</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% templates.forEach(template => { %>
                        <tr>
                            <td>
                                <strong><%= template.name %></strong>
                            </td>
                            <td>
                                <%= template.subject.length > 50 ? template.subject.substring(0, 50) + '...' : template.subject %>
                            </td>
                            <td>
                                <% if (template.is_active) { %>
                                    <span class="badge bg-success">Active</span>
                                <% } else { %>
                                    <span class="badge bg-secondary">Inactive</span>
                                <% } %>
                            </td>
                            <td>
                                <%= new Date(template.created_at).toLocaleDateString() %>
                            </td>
                            <td>
                                <%= new Date(template.updated_at).toLocaleDateString() %>
                            </td>
                            <td>
                                <button class="btn btn-outline-primary btn-sm" onclick="editTemplate(<%= template.id %>)" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="testTemplate(<%= template.id %>)" title="Send Test">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteTemplate(<%= template.id %>)" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    <% }) %>
                    <% if (templates.length === 0) { %>
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-envelope-open-text fa-3x text-muted mb-3"></i>
                                <p class="text-muted">No email templates found. Create your first template!</p>
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Template Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form id="templateForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="templateModalTitle">Add Email Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="templateId" name="id">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Template Name *</label>
                            <input type="text" class="form-control" id="templateName" name="name" required placeholder="e.g., promotional_forex">
                            <div class="form-text">Unique identifier for this template</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="templateActive" name="is_active">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email Subject *</label>
                        <input type="text" class="form-control" id="templateSubject" name="subject" required placeholder="Your Exclusive Trading Opportunity Awaits!">
                        <div class="form-text">Use {{first_name}} for personalization</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">HTML Content *</label>
                            <textarea class="form-control" id="templateHtml" name="html_content" rows="15" required placeholder="<div>Hello {{first_name}}, ...</div>"></textarea>
                            <div class="form-text">Full HTML email template with styling</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Plain Text Content *</label>
                            <textarea class="form-control" id="templateText" name="text_content" rows="15" required placeholder="Hello {{first_name}}, ..."></textarea>
                            <div class="form-text">Plain text version for email clients that don't support HTML</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Personalization:</strong> Use <code>{{first_name}}</code> in your content to automatically insert the lead's name.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Template
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Test Email Modal -->
<div class="modal fade" id="testEmailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Test Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="testTemplateId">
                <div class="mb-3">
                    <label class="form-label">Test Email Address</label>
                    <input type="email" class="form-control" id="testEmailAddress" required placeholder="test@example.com">
                    <div class="form-text">Enter your email to receive a test of this template</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendTestEmail()">
                    <i class="fas fa-paper-plane me-2"></i>Send Test
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let editingTemplateId = null;

// Add/Edit Template Form
document.getElementById('templateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    const url = editingTemplateId ? `/email-templates/api/${editingTemplateId}` : '/email-templates/api';
    const method = editingTemplateId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to save template'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to save template');
    });
});

// Edit Template
function editTemplate(id) {
    editingTemplateId = id;
    document.getElementById('templateModalTitle').textContent = 'Edit Email Template';
    
    fetch(`/email-templates/api/${id}`)
        .then(response => response.json())
        .then(template => {
            document.getElementById('templateId').value = template.id;
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateSubject').value = template.subject;
            document.getElementById('templateHtml').value = template.html_content;
            document.getElementById('templateText').value = template.text_content;
            document.getElementById('templateActive').value = template.is_active;
            
            new bootstrap.Modal(document.getElementById('templateModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load template');
        });
}

// Test Template
function testTemplate(id) {
    document.getElementById('testTemplateId').value = id;
    new bootstrap.Modal(document.getElementById('testEmailModal')).show();
}

// Send Test Email
function sendTestEmail() {
    const templateId = document.getElementById('testTemplateId').value;
    const testEmail = document.getElementById('testEmailAddress').value;
    
    if (!testEmail) {
        alert('Please enter a test email address');
        return;
    }
    
    fetch(`/email-templates/api/${templateId}/test`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ test_email: testEmail })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('testEmailModal')).hide();
            alert('Test email sent successfully!');
        } else {
            alert('Error: ' + (data.error || 'Failed to send test email'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to send test email');
    });
}

// Delete Template
function deleteTemplate(id) {
    if (confirm('Are you sure you want to delete this template?')) {
        fetch(`/email-templates/api/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to delete template'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete template');
        });
    }
}

// Reset form when modal is hidden
document.getElementById('templateModal').addEventListener('hidden.bs.modal', function () {
    editingTemplateId = null;
    document.getElementById('templateForm').reset();
    document.getElementById('templateModalTitle').textContent = 'Add Email Template';
});
</script>

