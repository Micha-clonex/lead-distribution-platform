<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Webhook Management</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWebhookModal">
            <i class="fas fa-plus me-2"></i>Add Webhook Source
        </button>
    </div>
</div>

<!-- Webhook Sources -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-download me-2"></i>Inbound Webhook Sources
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Country</th>
                                <th>Niche</th>
                                <th>Lead Type</th>
                                <th>Token</th>
                                <th>Webhook URL</th>
                                <th>Status</th>
                                <th>Leads Received</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% sources.forEach(source => { %>
                                <tr>
                                    <td>
                                        <strong><%= source.name %></strong>
                                        <% if (source.description) { %>
                                            <br><small class="text-muted"><%= source.description %></small>
                                        <% } %>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">
                                            <%= source.country ? source.country.charAt(0).toUpperCase() + source.country.slice(1) : 'N/A' %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-<%= source.niche === 'forex' ? 'success' : 'warning' %>">
                                            <%= source.niche ? source.niche.charAt(0).toUpperCase() + source.niche.slice(1) : 'N/A' %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-<%= source.lead_type === 'premium' ? 'primary' : 'secondary' %>">
                                            <%= source.lead_type ? source.lead_type.charAt(0).toUpperCase() + source.lead_type.slice(1) : 'Raw' %>
                                        </span>
                                    </td>
                                    <td>
                                        <code class="text-muted">
                                            <%= source.webhook_token.substring(0, 8) %>...
                                        </code>
                                        <button class="btn btn-sm btn-outline-secondary ms-2" data-action="copy-token" data-value="<%= source.webhook_token %>">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <code class="text-primary">
                                            <%= process.env.APP_URL || 'http://localhost:5000' %>/api/webhook/<%= source.webhook_token %>
                                        </code>
                                        <button class="btn btn-sm btn-outline-primary ms-2" data-action="copy-url" data-value="<%= process.env.APP_URL || 'http://localhost:5000' %>/api/webhook/<%= source.webhook_token %>">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <span class="badge bg-<%= source.is_active ? 'success' : 'danger' %>">
                                            <%= source.is_active ? 'Active' : 'Inactive' %>
                                        </span>
                                    </td>
                                    <td><%= source.leads_received || 0 %></td>
                                    <td><%= new Date(source.created_at).toLocaleDateString() %></td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-warning" data-action="toggle-webhook-status" data-id="<%= source.id %>">
                                                <i class="fas fa-<%= source.is_active ? 'pause' : 'play' %>"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" data-action="delete-webhook-source" data-id="<%= source.id %>">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Webhook Deliveries -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-upload me-2"></i>Recent Outbound Deliveries
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped data-table">
                        <thead>
                            <tr>
                                <th>Lead</th>
                                <th>Partner</th>
                                <th>Webhook URL</th>
                                <th>Status</th>
                                <th>Attempts</th>
                                <th>Partner Response</th>
                                <th>Created</th>
                                <th>Delivered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% deliveries.forEach(delivery => { %>
                                <tr>
                                    <td>
                                        <div>
                                            <strong>Lead #<%= delivery.lead_id %></strong>
                                            <br>
                                            <small class="text-muted"><%= delivery.lead_email %></small>
                                        </div>
                                    </td>
                                    <td><%= delivery.partner_name %></td>
                                    <td>
                                        <code class="text-muted">
                                            <%= delivery.webhook_url.length > 50 ? 
                                                delivery.webhook_url.substring(0, 50) + '...' : 
                                                delivery.webhook_url %>
                                        </code>
                                    </td>
                                    <td>
                                        <span class="badge bg-<%= 
                                            delivery.status === 'success' ? 'success' : 
                                            (delivery.status === 'failed' ? 'danger' : 'warning') %>">
                                            <%= delivery.status.charAt(0).toUpperCase() + delivery.status.slice(1) %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-<%= delivery.attempts > 1 ? 'warning' : 'secondary' %>">
                                            <%= delivery.attempts %>
                                        </span>
                                    </td>
                                    <td>
                                        <% if (delivery.response_code) { %>
                                            <div class="mb-1">
                                                <span class="badge bg-<%= delivery.response_code >= 200 && delivery.response_code < 300 ? 'success' : 'danger' %>">
                                                    HTTP <%= delivery.response_code %>
                                                </span>
                                            </div>
                                        <% } %>
                                        <% if (delivery.response_body && delivery.response_body.trim() !== '') { %>
                                            <small class="text-<%= delivery.status === 'success' ? 'success' : 'danger' %>" style="word-break: break-word; font-size: 0.75rem;">
                                                <%= delivery.response_body.length > 80 ? delivery.response_body.substring(0, 80) + '...' : delivery.response_body %>
                                            </small>
                                        <% } else { %>
                                            <small class="text-muted">No response details</small>
                                        <% } %>
                                    </td>
                                    <td><%= new Date(delivery.created_at).toLocaleDateString() %></td>
                                    <td>
                                        <% if (delivery.delivered_at) { %>
                                            <%= new Date(delivery.delivered_at).toLocaleDateString() %>
                                        <% } else { %>
                                            <span class="text-muted">-</span>
                                        <% } %>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" data-action="view-delivery-details" data-id="<%= delivery.id %>" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <% if (delivery.status === 'failed' && delivery.attempts < 3) { %>
                                            <button class="btn btn-outline-success" onclick="retryDelivery(<%= delivery.id %>)" title="Retry">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                            <% } %>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Webhook Source Modal -->
<div class="modal fade" id="addWebhookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="/webhooks/sources" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title">Add Webhook Source</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Source Name *</label>
                        <input type="text" class="form-control" name="name" required placeholder="Facebook Leads, Landing Page, etc.">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Source Type *</label>
                        <select class="form-control" name="source_type" required>
                            <option value="">Select source type...</option>
                            <option value="facebook">Facebook Ads</option>
                            <option value="google">Google Ads</option>
                            <option value="landing_page">Landing Page</option>
                            <option value="crm">CRM System</option>
                            <option value="affiliate">Affiliate Network</option>
                            <option value="email_campaign">Email Campaign</option>
                            <option value="api">API Integration</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Country *</label>
                            <select class="form-control" name="country" required>
                                <option value="">Select Country</option>
                                <option value="germany">Germany</option>
                                <option value="austria">Austria</option>
                                <option value="spain">Spain</option>
                                <option value="canada">Canada</option>
                                <option value="italy">Italy</option>
                                <option value="uk">United Kingdom</option>
                                <option value="norway">Norway</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Niche *</label>
                            <select class="form-control" name="niche" required>
                                <option value="">Select Niche</option>
                                <option value="forex">Forex</option>
                                <option value="recovery">Recovery</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lead Type *</label>
                        <select class="form-control" name="lead_type" required>
                            <option value="">Select Lead Type</option>
                            <option value="premium">Premium Leads</option>
                            <option value="raw">Raw Leads</option>
                        </select>
                        <div class="form-text">
                            <small class="text-muted">
                                <strong>Premium:</strong> High-quality leads with verified information<br>
                                <strong>Raw:</strong> Basic leads that may require additional qualification
                            </small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Brief description of this webhook source"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> A unique token will be generated for this webhook source. 
                        You'll use this token in the webhook URL to send leads to this system.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Webhook Source</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function copyToken(token) {
    navigator.clipboard.writeText(token).then(function() {
        alert('Token copied to clipboard!');
    });
}

function copyUrl(token) {
    const baseUrl = '<%= process.env.APP_URL || "http://localhost:5000" %>';
    const url = baseUrl + '/api/webhook/' + token;
    navigator.clipboard.writeText(url).then(function() {
        alert('Webhook URL copied to clipboard!');
    });
}

function toggleWebhookStatus(id, currentStatus) {
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
    
    fetch(`/webhooks/sources/${id}/status`, {
        method: 'PUT',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to update webhook status');
        }
    });
}

function deleteWebhookSource(id) {
    if (confirm('Are you sure you want to delete this webhook source? This action cannot be undone.')) {
        fetch(`/webhooks/sources/${id}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to delete webhook source');
            }
        });
    }
}

function viewDeliveryDetails(id) {
    fetch(`/webhooks/deliveries/${id}`, {
        method: 'GET',
        credentials: 'same-origin', // Include session cookies
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    })
        .then(response => {
            // Check if we got redirected to login page
            if (response.url && response.url.includes('/admin/login')) {
                alert('Session expired. Please login again.');
                window.location.href = '/admin/login';
                return;
            }
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.json();
        })
        .then(data => {
            if (data && data.success) {
                showDeliveryModal(data.delivery);
            } else {
                alert('Failed to load delivery details: ' + (data?.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading delivery details:', error);
            alert('Error loading delivery details: ' + error.message);
        });
}

function showDeliveryModal(delivery) {
    const modalHtml = `
        <div class="modal fade" id="deliveryDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-info-circle me-2"></i>
                            Webhook Delivery Details - Lead #${delivery.lead_id}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Lead Information -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="fw-bold text-primary">Lead Information</h6>
                                <table class="table table-sm">
                                    <tr><td class="fw-bold">Name:</td><td>${delivery.first_name} ${delivery.last_name}</td></tr>
                                    <tr><td class="fw-bold">Email:</td><td>${delivery.email}</td></tr>
                                    <tr><td class="fw-bold">Phone:</td><td>${delivery.phone || 'N/A'}</td></tr>
                                    <tr><td class="fw-bold">Country:</td><td>${delivery.lead_country}</td></tr>
                                    <tr><td class="fw-bold">Niche:</td><td>${delivery.lead_niche}</td></tr>
                                    <tr><td class="fw-bold">Type:</td><td>
                                        <span class="badge bg-${delivery.type === 'premium' ? 'primary' : 'secondary'}">
                                            ${delivery.type}
                                        </span>
                                    </td></tr>
                                    <tr><td class="fw-bold">Source:</td><td>${delivery.source}</td></tr>
                                    <tr><td class="fw-bold">Created:</td><td>${new Date(delivery.lead_created_at).toLocaleString()}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold text-success">Partner Information</h6>
                                <table class="table table-sm">
                                    <tr><td class="fw-bold">Partner:</td><td>${delivery.partner_name}</td></tr>
                                    <tr><td class="fw-bold">Country:</td><td>${delivery.partner_country}</td></tr>
                                    <tr><td class="fw-bold">Niche:</td><td>${delivery.partner_niche}</td></tr>
                                    <tr><td class="fw-bold">Webhook URL:</td><td><code style="font-size: 0.8rem; word-break: break-all;">${delivery.webhook_url}</code></td></tr>
                                </table>
                            </div>
                        </div>

                        <!-- Delivery Status -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="fw-bold text-warning">Delivery Status</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td class="fw-bold">Status:</td>
                                        <td>
                                            <span class="badge bg-${delivery.status === 'success' ? 'success' : (delivery.status === 'failed' ? 'danger' : 'warning')} fs-6">
                                                ${delivery.status.toUpperCase()}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr><td class="fw-bold">Attempts:</td><td>${delivery.attempts}</td></tr>
                                    <tr><td class="fw-bold">Created:</td><td>${new Date(delivery.created_at).toLocaleString()}</td></tr>
                                    ${delivery.delivered_at ? `<tr><td class="fw-bold">Delivered:</td><td>${new Date(delivery.delivered_at).toLocaleString()}</td></tr>` : ''}
                                    ${delivery.response_code ? `<tr><td class="fw-bold">Response Code:</td><td><span class="badge bg-${delivery.response_code >= 200 && delivery.response_code < 300 ? 'success' : 'danger'}">HTTP ${delivery.response_code}</span></td></tr>` : ''}
                                </table>
                            </div>
                        </div>

                        <!-- Payload Sent -->
                        <div class="mb-4">
                            <h6 class="fw-bold text-info">Payload Sent to Partner</h6>
                            <div class="bg-light border rounded p-3">
                                <pre style="margin: 0; font-size: 0.85rem; white-space: pre-wrap;">${delivery.payload ? JSON.stringify(delivery.payload, null, 2) : 'No payload data'}</pre>
                            </div>
                        </div>

                        <!-- Partner Response -->
                        ${delivery.response_body ? `
                        <div class="mb-4">
                            <h6 class="fw-bold text-${delivery.status === 'success' ? 'success' : 'danger'}">Partner Response</h6>
                            <div class="bg-light border rounded p-3">
                                <pre style="margin: 0; font-size: 0.85rem; white-space: pre-wrap; color: ${delivery.status === 'success' ? '#198754' : '#dc3545'};">${typeof delivery.response_body === 'object' ? JSON.stringify(delivery.response_body, null, 2) : delivery.response_body}</pre>
                            </div>
                        </div>` : ''}
                    </div>
                    <div class="modal-footer">
                        ${delivery.status === 'failed' && delivery.attempts < 3 ? `
                        <button type="button" class="btn btn-success" onclick="retryDelivery(${delivery.id}); $('#deliveryDetailsModal').modal('hide');">
                            <i class="fas fa-redo me-2"></i>Retry Delivery
                        </button>` : ''}
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if present
    const existing = document.getElementById('deliveryDetailsModal');
    if (existing) existing.remove();

    // Add modal to page and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('deliveryDetailsModal'));
    modal.show();
    
    // Clean up when modal is hidden
    document.getElementById('deliveryDetailsModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function retryDelivery(id) {
    if (confirm('Retry this webhook delivery?')) {
        fetch(`/webhooks/deliveries/${id}/retry`, {
            method: 'POST',
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Webhook delivery queued for retry');
                location.reload();
            } else {
                alert('Failed to retry delivery: ' + data.message);
            }
        });
    }
}
</script>